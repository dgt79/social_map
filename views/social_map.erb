<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
    
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>FB Graph api & Javascript </title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <style type="text/css">
      html {
          height: 100%
      }

      body {
          height: 100%;
          margin: 0px;
          padding: 0px
      }

      #map_canvas {
          height: 100%
      }
  </style>

  <script type="text/javascript"
          src="http://maps.google.com/maps/api/js?sensor=false">
  </script>

  <script type="text/javascript">
      var initialLocation;
      var siberia = new google.maps.LatLng(60, 105);
      var marker;
      var browserSupportFlag = new Boolean();
      var map;
      var geocoder;

      function initialize() {
          var myOptions = {
              zoom: 3,
              mapTypeId: google.maps.MapTypeId.ROADMAP
          };
          map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
          geocoder = new google.maps.Geocoder();

          // Try W3C Geolocation (Preferred)
          if (navigator.geolocation) {
              browserSupportFlag = true;
              navigator.geolocation.getCurrentPosition(function(position) {
                  initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                  map.setCenter(initialLocation);
                  marker = new google.maps.Marker({
                      map:map,
                      draggable:false,
                      animation: google.maps.Animation.DROP,
                      position: initialLocation
                  });
                  google.maps.event.addListener(marker, 'click', toggleBounce);
              }, function() {
                  handleNoGeolocation(browserSupportFlag);
              });
              // Try Google Gears Geolocation
          } else if (google.gears) {
              browserSupportFlag = true;
              var geo = google.gears.factory.create('beta.geolocation');
              geo.getCurrentPosition(function(position) {
                  initialLocation = new google.maps.LatLng(position.latitude, position.longitude);
                  map.setCenter(initialLocation);
                  marker = new google.maps.Marker({
                      map:map,
                      draggable:false,
                      animation: google.maps.Animation.DROP,
                      position: initialLocation
                  });
                  google.maps.event.addListener(marker, 'click', toggleBounce);
              }, function() {
                  handleNoGeoLocation(browserSupportFlag);
              });
              // Browser doesn't support Geolocation
          } else {
              browserSupportFlag = false;
              handleNoGeolocation(browserSupportFlag);
          }

          function handleNoGeolocation(errorFlag) {
              if (errorFlag == true) {
                  alert("Geolocation service failed.");
                  initialLocation = newyork;
              } else {
                  alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
                  initialLocation = siberia;
              }
              map.setCenter(initialLocation);
          }

          function toggleBounce() {

              if (marker.getAnimation() != null) {
                  marker.setAnimation(null);
              } else {
                  marker.setAnimation(google.maps.Animation.BOUNCE);
              }
          }
      }

      function placeMarker(address) {
          geocoder.geocode({ 'address': address}, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
//                  map.setCenter(results[0].geometry.location);
                  var marker = new google.maps.Marker({
                      map: map,
                      draggable:false,
                      animation: google.maps.Animation.DROP,
                      position: results[0].geometry.location
                  });
                  drawPolyline(initialLocation, results[0].geometry.location);
              } else {
                  console.log("Geocode for " + address + " was not successful for the following reason: " + status);
//                      let's retry
//                      setTimeout(placeMarker(address), 1000);
              }
          });
      }

      function drawPolyline(from, to) {
          var flightPlanCoordinates = [
              from,
              to
          ];
          var flightPath = new google.maps.Polyline({
              path: flightPlanCoordinates,
              strokeColor: "#dc322f",
              strokeOpacity: 0.5,
              strokeWeight: 1
          });
          flightPath.setMap(map);
      }
  </script>
</head>
    
<body onload="initialize()">
<div id="fb-root"></div>
        
<script type="text/javascript">
    window.fbAsyncInit = function() {
        FB.init({appId: '142633465810557', status: true, cookie: true, xfbml: true});

        FB.Event.subscribe('auth.login', function(response) {
            login();
        });

        FB.Event.subscribe('auth.logout', function(response) {
            logout();
        });

        FB.getLoginStatus(function(response) {
            if (response.session) {
                login();
            }
        });
    };
    (function() {
        var e = document.createElement('script');
        e.type = 'text/javascript';
        e.src = document.location.protocol +
                '//connect.facebook.net/en_US/all.js';
        e.async = true;
        document.getElementById('fb-root').appendChild(e);
    }());

    function login() {
        FB.api('/me', function(response) {
//            document.getElementById('login').style.display = "block";
            document.getElementById('login').innerHTML = response.name + " succsessfully logged in!";
            social_map();
        });
    }
    function logout() {
        document.getElementById('login').style.display = "none";
    }

    function social_map() {
        FB.api('/me', function(response) {
            var query = FB.Data.query("SELECT name, current_location from user where uid in " +
                    '(SELECT uid2 from friend where uid1={0})', response.id);
            FB.Data.waitOn([query], function() {
                var locationCount = new Array();
                FB.Array.forEach(query.value, function(row) {
                    if (row.current_location != null) {
//                        console.log(row.current_location);
                        var location = row.current_location['city'] + ', ' + row.current_location['country'];
                        locationCount[location] = (locationCount[location] || 0) + 1;
                        if (locationCount[location] == 1) {
                            placeMarker(location);
                        }
                    }
                });
            });
        });
    }

</script>
<fb:login-button autologoutlink="true" perms="email,user_location,friends_location"></fb:login-button>
<div id="login" style="display:none"></div>
<div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>